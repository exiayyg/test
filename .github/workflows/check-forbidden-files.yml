name: Check for forbidden files

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

# å¿…é¡»æ˜¾å¼å£°æ˜æƒé™ï¼Œå¦åˆ™ schedule ä¸‹æ— æ³• push
permissions:
  contents: write
  pull-requests: write

jobs:
  check-forbidden-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Godot cache files
        id: check-godot
        shell: bash
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æŸ¥æ˜¯å¦æœ‰è¢« Git è¿½è¸ªçš„ .godot ç›®å½•..."

          if git ls-files | grep -q '^\.godot/'; then
            echo "âŒ å‘ç°è¢« Git è¿½è¸ªçš„ .godot ç¼“å­˜ç›®å½•"
            echo "::error title=Forbidden Files Detected::å‘ç° .godot ç¼“å­˜ç›®å½•è¢«æäº¤åˆ°ä»“åº“ï¼Œè¯·ç«‹å³ç§»é™¤ï¼"
            echo "found=true" >> "$GITHUB_OUTPUT"

            echo ""
            echo "ğŸ“‚ è¢«è¿½è¸ªçš„è¿è§„æ–‡ä»¶åˆ—è¡¨ï¼š"
            git ls-files | grep '^\.godot/' || true

            exit 1
          else
            echo "âœ… æœªå‘ç°è¢« Git è¿½è¸ªçš„ .godot ç›®å½•"
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Scheduled cleanup of forbidden files
        if: steps.check-godot.outputs.found == 'true' && github.event_name == 'schedule'
        shell: bash
        run: |
          echo "ğŸ§¹ å¼€å§‹è‡ªåŠ¨æ¸…ç† .godot ç¼“å­˜ç›®å½•ï¼ˆä»…ç§»é™¤ Git è¿½è¸ªï¼‰..."

          git rm -r --cached .godot || true

          # ç¡®ä¿ .gitignore ä¸­åŒ…å«è§„åˆ™
          if [ ! -f .gitignore ]; then
            touch .gitignore
          fi

          if ! grep -q '^\.godot/' .gitignore; then
            echo ".godot/" >> .gitignore
            echo "â• å·²è¡¥å…… .gitignore å¿½ç•¥è§„åˆ™"
          fi

          if [ -n "$(git status --porcelain)" ]; then
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git commit -m "chore: remove .godot cache directory [skip ci]"
            git push origin HEAD:main
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          fi

      - name: Post notification to PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                'âš ï¸ **æ£€æµ‹åˆ°è¿è§„æ–‡ä»¶æäº¤**',
                '',
                'å‘ç° `.godot` ç¼“å­˜ç›®å½•è¢«æäº¤åˆ°ä»“åº“ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å¤„ç†ï¼š',
                '',
                '1. ä» Git ä¸­ç§»é™¤ç¼“å­˜ç›®å½•ï¼š',
                '   ```bash',
                '   git rm -r --cached .godot',
                '   ```',
                '',
                '2. ç¡®ä¿ `.gitignore` ä¸­åŒ…å«ï¼š',
                '   ```',
                '   .godot/',
                '   ```',
                '',
                '3. æäº¤å¹¶æ¨é€ä¿®æ”¹',
                '',
                '**è¯·å‹¿æäº¤ä»»ä½•å¼•æ“ / IDE / ç¼–è¾‘å™¨ç”Ÿæˆçš„ç¼“å­˜æ–‡ä»¶ã€‚**'
              ].join('\n')
            })
